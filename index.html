<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Craftland UID Hex Editor</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  ::selection { background: #6366f1; color: white; }
</style>
</head>

<body class="bg-gradient-to-br from-zinc-900 to-black min-h-screen flex items-center justify-center p-6 text-zinc-100">

<div class="w-full max-w-3xl backdrop-blur bg-zinc-900/80 rounded-2xl shadow-2xl p-6 space-y-6">

  <h1 class="text-2xl font-bold text-center text-indigo-400">
    Craftland UID Binary Editor
  </h1>

  <!-- Upload -->
  <div id="dropZone"
       class="border-2 border-dashed border-zinc-600 rounded-xl p-6 text-center cursor-pointer hover:border-indigo-500 transition">
    <p class="text-sm text-zinc-400">Drag &amp; Drop .bytes file or click</p>
    <input id="fileInput" type="file" class="hidden" />
  </div>

  <!-- Info -->
  <div class="grid grid-cols-2 gap-4 text-sm">
    <div>
      <span class="text-zinc-400">Detected UID:</span>
      <div id="uidVal" class="font-mono text-indigo-400">—</div>
    </div>
    <div>
      <span class="text-zinc-400">Offset:</span>
      <div id="uidOff" class="font-mono">—</div>
    </div>
  </div>

  <!-- Input -->
  <input id="newUid" type="text"
         placeholder="New UID"
         class="w-full bg-zinc-800 rounded-lg p-2 font-mono outline-none focus:ring focus:ring-indigo-500">

  <!-- Buttons -->
  <div class="flex gap-3">
    <button id="updateBtn"
      class="flex-1 bg-indigo-600 hover:bg-indigo-500 rounded-lg p-2 font-semibold">
      Update UID
    </button>
    <button id="clearBtn"
      class="flex-1 bg-red-600 hover:bg-red-500 rounded-lg p-2 font-semibold">
      Clear UID
    </button>
  </div>

  <!-- Hex Preview -->
  <div>
    <h2 class="text-sm text-zinc-400 mb-1">Hex Preview</h2>
    <pre id="hexPreview"
         class="bg-black rounded-lg p-4 text-xs font-mono overflow-x-auto max-h-64 text-zinc-400">
—
    </pre>
  </div>

  <div id="status" class="text-center text-sm text-zinc-400"></div>
</div>

<script>
let buf, uidInfo, fileName;

const dropZone = document.getElementById("dropZone");
const fileInput = document.getElementById("fileInput");
const uidVal = document.getElementById("uidVal");
const uidOff = document.getElementById("uidOff");
const newUid = document.getElementById("newUid");
const updateBtn = document.getElementById("updateBtn");
const clearBtn = document.getElementById("clearBtn");
const hexPreview = document.getElementById("hexPreview");
const statusEl = document.getElementById("status");

// -------- VARINT ----------
function decodeVarint(bytes, start) {
  let v = 0n;
  let shift = 0n;
  let i = start;
  while (true) {
    let b = bytes[i];
    v |= BigInt(b & 0x7F) << shift;
    if (!(b & 0x80)) break;
    shift += 7n;
    i++;
  }
  return { value: v, length: i - start + 1 };
}

function encodeVarint(n) {
  n = BigInt(n);
  let out = [];
  while (n > 0x7Fn) {
    out.push(Number((n & 0x7Fn) | 0x80n));
    n >>= 7n;
  }
  out.push(Number(n));
  return new Uint8Array(out);
}

// -------- FIND UID ----------
function findUID(b) {
  for (let i = 0; i < b.length - 5; i++) {
    if (b[i] !== 0x38) continue;
    try {
      let v = decodeVarint(b, i + 1);
      let end = i + 1 + v.length;
      if (b[end] === 0x42 && v.length >= 3 && v.value > 100000n) {
        return { start: i + 1, length: v.length, value: v.value };
      }
    } catch (error) {
      continue;
    }
  }
  return null;
}

// -------- PREVIEW ----------
function renderPreview() {
  const start = Math.max(0, uidInfo.start - 32);
  const end = Math.min(buf.length, uidInfo.start + uidInfo.length + 32);
  const parts = [];

  for (let i = start; i < end; i++) {
    let hex = buf[i].toString(16).padStart(2, "0");
    if (i >= uidInfo.start && i < uidInfo.start + uidInfo.length) {
      parts.push(`<span class="text-indigo-400">${hex}</span>`);
    } else {
      parts.push(hex);
    }
  }

  hexPreview.innerHTML = parts.join(" ");
}

// -------- LOAD ----------
function loadFile(f) {
  fileName = f.name;
  let r = new FileReader();
  r.onload = e => {
    buf = new Uint8Array(e.target.result);
    uidInfo = findUID(buf);
    if (!uidInfo) {
      status("❌ UID not found");
      uidVal.textContent = "—";
      uidOff.textContent = "—";
      hexPreview.textContent = "—";
      return;
    }
    uidVal.textContent = uidInfo.value.toString();
    uidOff.textContent = "0x" + uidInfo.start.toString(16);
    renderPreview();
    status("✔ UID detected");
  };
  r.readAsArrayBuffer(f);
}

// -------- UPDATE ----------
function applyUID(val) {
  let v = encodeVarint(val);
  let head = buf.slice(0, uidInfo.start);
  let tail = buf.slice(uidInfo.start + uidInfo.length);
  buf = new Uint8Array([...head, ...v, ...tail]);
  uidInfo = { ...uidInfo, length: v.length, value: BigInt(val) };
  renderPreview();
  download();
}

// -------- UI ----------
dropZone.onclick = () => fileInput.click();
fileInput.onchange = e => {
  if (e.target.files[0]) loadFile(e.target.files[0]);
};

dropZone.ondragover = e => e.preventDefault();

dropZone.ondrop = e => {
  e.preventDefault();
  if (e.dataTransfer.files[0]) loadFile(e.dataTransfer.files[0]);
};

updateBtn.onclick = () => {
  if (!uidInfo) return status("Upload a file first");
  let v = newUid.value.trim();
  if (!/^\d+$/.test(v)) return status("Invalid UID");
  applyUID(v);
};

clearBtn.onclick = () => {
  if (!uidInfo) return status("Upload a file first");
  applyUID(0);
};

function status(t) {
  statusEl.textContent = t;
}

function download() {
  let a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([buf]));
  a.download = fileName;
  a.click();
  status("✔ File exported");
}
</script>

</body>
</html>
